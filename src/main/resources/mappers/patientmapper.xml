<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.solvd.hospital.db.mapper.PatientMapper">
    <select id="selectPatientById" resultMap="patientResultMap">
        SELECT P.id as patient_id, P.name as patient_name, P.address as patient_address,
        P.phoneNumber as patient_number, D.name as doc_name, D.employeeId as doc_id, D.position as doc_position,
        Dep.id as dep_id, Dep.name as dep_name, N.name as nur_name, N.employeeId as nur_id,
        N.position as nur_position, I.id as insurance_id, I.name as insurance_name,
        PMC.reportId as pmc_id, PMC.diagnosis as pmc_diagnosis, PMC.dateVisted as pmc_date
        FROM Patient P
        JOIN Doctor D ON P.Doctor_employeeId = D.employeeId
        JOIN Nurse N ON P.Nurse_employeeId = N.employeeId
        JOIN Departments Dep ON D.Departments_id = Dep.id OR N.Departments_id = Dep.id
        JOIN Insurance I ON P.Insurance_id = I.id
        JOIN PatientMedicalChart PMC ON PMC.reportId = P.PatientMedicalChart_reportId
        WHERE P.id= #{id}
    </select>
    <update id="updatePatient">
        UPDATE Patient SET name=#{name}, address=#{address}, phoneNumber=#{phoneNumber} WHERE id=#{id}
    </update>
    <delete id="deletePatientById">
        DELETE FROM Patient WHERE id = #{id}
    </delete>
    <insert id="savePatientToDB">
        INSERT INTO Patient (name, Doctor_employeeId, PatientMedicalChart_reportId, Nurse_employeeId, Insurance_id, id, address, phoneNumber)
        VALUES (#{name}, #{doctor.id}, #{chart.id}, #{nurse.id}, #{insurance.id}, #{id}, #{address}, #{phoneNumber})
    </insert>
    <resultMap id="patientResultMap" type="com.solvd.hospital.model.patient.Patient">
        <id property="id" column="patient_id"/>
        <result property="name" column="patient_name"/>
        <result property="address" column="patient_address"/>
        <result property="phoneNumber" column="patient_number"/>
        <collection property="doctor" resultMap="com.solvd.hospital.db.mapper.DoctorMapper.doctorResultMap"/>
        <collection property="nurse" resultMap="com.solvd.hospital.db.mapper.NurseMapper.nurseResultMap"/>
        <collection property="insurance" resultMap="com.solvd.hospital.db.mappers.InsuranceMapper.insuranceResultMap"/>
        <collection property="chart" resultMap="com.solvd.hospital.db.mappers.PatientMedicalChartMapper.pmcResultMap"/>
    </resultMap>
</mapper>